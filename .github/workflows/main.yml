---

name: Main

on: [push, pull_request]

jobs:
  node-tests:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout code
      uses: actions/checkout@v2

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v2
      with:
        node-version: 14.x

    - name: Build
      run: |
        rm -Rf node_modules/ganache-core/node_modules/web3-providers-ws/node_modules/websocket/.git
        npm install
        npm run build

    - name: Run tests
      run: |
        cd packages/common
        npm install
        npm run test
        npm pack

        cd ../census
        npm install ../common/vocdoni-common*.tgz
        cd ../client
        npm install ../common/vocdoni-common*.tgz
        cd ../data-models
        npm install ../common/vocdoni-common*.tgz
        cd ../encryption
        npm install ../common/vocdoni-common*.tgz
        cd ../voting
        npm install ../common/vocdoni-common*.tgz
        cd ../wallets
        npm install ../common/vocdoni-common*.tgz
        cd ..

        cd packages/signing
        npm install
        npm run test
        npm pack

        cd ../census
        npm install ../common/vocdoni-signing*.tgz
        cd ../client
        npm install ../common/vocdoni-signing*.tgz
        cd ../voting
        npm install ../common/vocdoni-signing*.tgz
        cd ../wallets
        npm install ../common/vocdoni-signing*.tgz
        cd ..

        cd packages/hashing
        npm install
        npm run test
        npm pack

        cd ../census
        npm install ../common/vocdoni-hashing*.tgz
        cd ../voting
        npm install ../common/vocdoni-hashing*.tgz
        cd ..

        cd packages/encryption
        npm install
        npm run test
        npm pack

        cd ../data-models
        npm install ../common/vocdoni-encryption*.tgz
        cd ../voting
        npm install ../common/vocdoni-encryption*.tgz
        cd ..

        cd packages/contract-wrappers
        npm install
        npm run test
        npm pack

        cd ../data-models
        npm install ../common/vocdoni-contract-wrappers*.tgz
        cd ../census
        npm install ../common/vocdoni-contract-wrappers*.tgz
        cd ../voting
        npm install ../common/vocdoni-contract-wrappers*.tgz
        cd ..

        cd packages/data-models
        npm install
        npm run test
        npm pack

        cd ../client
        npm install ../common/vocdoni-data-models*.tgz
        cd ../census
        npm install ../common/vocdoni-data-models*.tgz
        cd ../voting
        npm install ../common/vocdoni-data-models*.tgz
        cd ..

        cd packages/wallets
        npm install
        npm run test
        npm pack

        cd ..

        cd packages/client
        npm install
        npm run test
        npm pack

        cd ../census
        npm install ../common/vocdoni-client*.tgz
        cd ../voting
        npm install ../common/vocdoni-client*.tgz
        cd ..

        cd packages/census
        npm install
        npm run test
        npm pack

        cd ..

        cd packages/voting
        npm install
        npm run test
        npm pack

        cd ..

